<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Promise tests</title>
    <style>
        .content{
            position: relative;
            width: 800px;
            margin: 100px auto;
        }
        #info{
            color: green;
            font-size: 20px;
            line-height: 2;
        }
    </style>
</head>
<body>


<div class="content">
    输入请求JSON地址: <input type="text" id="url" placeholder="输入远程json地址"> <br>
    查询ClashRoyale数据:<input type="text" id="crInput" placeholder="输入卡牌">
    <div id="info" style="margin-top: 20px">

    </div>
</div>

<!--scripts-->

<script>
    (function () {

        let input = document.getElementById("crInput"),
            info = document.getElementById("info"),
            jsonUrl = document.getElementById("url");

        /*绑定事件*/
        input.addEventListener("input", function (e) {
            info.innerHTML = '正在查询';
            let promise = new Promise(function (resolve, reject) {
                AJAX(jsonUrl.value || "data.json", json => resolve(json), (error) => reject(`错误代码"${error}"... <img src=images/clashRoyale/emotions/cry.gif />`));
            });
            promise.then(json => show(json), error => info.innerHTML = error);
        });


        function show(json){
            let html = '';
            json = JSON.parse(json);
            for (let data of Object.keys(json)) {
                if (data == input.value) {
                    for (let [key,value] of Object.entries(json[data])) {
                        html += key + ": " + value + "<br>";
                    }
                    html += "缩略图: <img src=images/clashRoyale/cards/" + json[data]['英文名'] + ".png /> <br>";
                    info.innerHTML = html;
                    return;
                } else {
                    info.innerHTML = '未找到相应数据 <img src=images/clashRoyale/emotions/cry.gif />';
                }
            }
        }


        /**
         * AJAX调用
         * @param type 可选值post,get(默认)
         * @param callback 成功回调函数
         * @param error 失败回调函数
         * @param url
         */
        function AJAX(url, callback, error, type = 'get') {
            var XHR = new XMLHttpRequest();
            XHR.open(type, url);
            XHR.onreadystatechange = function () {
                if (XHR.readyState == 4 && XHR.status == 200) {
                    callback(XHR.responseText);
                }
                if (XHR.status == 404 || XHR.status == 500) {
                    error(XHR.status + ' ' + XHR.statusText);
                }
            };
            XHR.send();
        }

    })()
</script>

</body>
</html>
